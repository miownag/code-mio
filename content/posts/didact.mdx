ğŸš€ **æœ¬æ–‡è¢«æ”¶å½•è‡³** [ã€Œå­—èŠ‚å‰ç«¯ã€å®˜æ–¹è´¦å·](https://mp.weixin.qq.com/s/EL3Qu6SB9pct4d_vF7XVtQ) ğŸš€

# èƒŒæ™¯

ä½œä¸ºå‰ç«¯å¼€å‘å·¥ç¨‹å¸ˆï¼Œå­¦ä¹ è‡ªå·±å¹³æ—¶ä½¿ç”¨çš„å‰ç«¯æ¡†æ¶çš„æºç æ˜¯éå¸¸æœ‰å¸®åŠ©çš„ï¼Œä½†æ˜¯æ·±å…¥ä¸€ä¸ªæ¡†æ¶æºç çš„å­¦ä¹ ï¼Œå¾€å¾€ä¼šé‡åˆ°å¦‚ä¸‹ç­‰è¯¸å¤šé—®é¢˜ï¼š

1.  æºç çš„åŒ…å’Œä»£ç é‡å¤ªå¤šï¼Œæ— ä»ä¸‹æ‰‹ï¼›

2.  æºç å¤ªå¤æ‚ï¼Œå­¦ä¹ æˆæœ¬å¤ªé«˜ï¼›

3.  æ‰¾ä¸€äº›æ–‡ç« æ¥å¯¼å­¦ï¼Œå‘ç°æ–‡ç« ç”¨çš„æ¡†æ¶ç‰ˆæœ¬è½åã€‚

# ç®€ä»‹

Didactå°±å¯ä»¥ä½œä¸ºè¿™æ ·çš„ä¸€å—æ•²é—¨ç –ï¼Œåœ¨Didactçš„[å®˜ç½‘](https://pomb.us/build-your-own-react/)ï¼Œä½œè€…**Rodrigo Pombo**è¿™æ ·ä»‹ç»Didactï¼š

> We are going to rewrite React from scratch. Step by step. Following the architecture from the real React code but without all the optimizations and non-essential features.
>
> **ç¿»è¯‘**ï¼š
>
> æˆ‘ä»¬å°†ä¸€æ­¥æ­¥åœ°ä»å¤´å¼€å§‹é‡å†™Reactã€‚æˆ‘ä»¬ä¼šéµå¾ªçœŸæ­£çš„Reactæºç çš„æ¶æ„ï¼Œä½†ä¸ä¼šå®ç°æ‰€æœ‰çš„ä¼˜åŒ–å’Œéå¿…è¦çš„åŠŸèƒ½ã€‚

æ‰€ä»¥ç®€å•æ¥è¯´ï¼ŒDidactå°±æ˜¯å®ç°äº†ä¸€ä¸ªç®€æ˜“çš„Reactæ¡†æ¶ã€‚

å› æ­¤ï¼Œæˆ‘ä»¬ä»¥Didactä½œä¸º**å¼•å¯¼**ï¼Œå°†æ¥å­¦ä¹ Reactæºç çš„æ—¶å€™ï¼Œå¯ä»¥æ›´å¥½åœ°è§£å†³ä¸Šè¿°æåˆ°çš„çš„é—®é¢˜ï¼š

1.  å¼•å¯¼æˆ‘ä»¬é€æ­¥ç†è§£Didactï¼Œä¸”è¿™ä¸ªè¿‡ç¨‹ä¸ç†è§£Reactæ˜¯ä¸€è‡´çš„ï¼›

2.  ä»£ç æ¸…æ™°ï¼Œç†è§£éš¾åº¦å°ï¼Œä¾¿äºå…¥é—¨å’Œä¸Šæ‰‹ï¼›

3.  æ²¿ç”¨äº†Reactçš„è®¾è®¡**ç†å¿µä¸æ€æƒ³**ï¼ŒReactä»16.8ä»¥åï¼Œä»£ç åœ¨å˜ä½†æ€æƒ³æ²¡å˜ï¼Œå­¦ä¹ Didactå¯ä»¥å¸®åŠ©æˆ‘ä»¬äº†è§£Reactçš„ç†å¿µä¸æ€æƒ³ã€‚

# æ ¸å¿ƒèƒ½åŠ›

![image.png](/posts/didact/didact-struct.png)

# åŸç†ä¸æºç è§£æ

## ä»ä¸€ä¸ªç®€å•çš„ä¾‹å­å¼€å§‹

```typescript
// ä¸€ä¸ªjsx element
const element = <h1 title="foo">Hello</h1>;
// ä¸€ä¸ªæ ¹ç»“ç‚¹å®¹å™¨
const container = document.getElementById("root");
// å°†elementæ¸²æŸ“åˆ°å®¹å™¨é‡Œ
ReactDOM.render(element, container);
```

è¿™æ®µä»£ç ç”¨Reactå®ç°äº†ä¸€ä¸ªæœ€ç®€å•çš„åº”ç”¨ï¼šå°†ä¸€ä¸ªh1æ¸²æŸ“åˆ°rootå®¹å™¨é‡Œã€‚

ä¹‹æ‰€ä»¥æˆ‘ä»¬å¯ä»¥åœ¨.jsxæ–‡ä»¶é‡Œå†™ç±»ä¼¼htmlæ ‡ç­¾çš„JSXï¼Œæ˜¯å› ä¸ºbabelä¼šåœ¨æ‰“åŒ…æ—¶å°†JSXè½¬ä¹‰ä¸ºReact.createElement(args)æˆ–è€…\_jsx(args)ï¼Œæœ¬è´¨ä¸ŠJSXå†™æ³•å°±æ˜¯è¿™ä¸¤ä¸ªæ–¹æ³•çš„è¯­æ³•ç³–ï¼Œæœ¬æ–‡ä¸­éƒ½å°†ä»¥createElementä¸ºä¾‹ï¼š

```typescript
const element = <h1 title="foo">Hello</h1>;
// ä¼šè¢«babelè½¬ä¹‰ä¸ºå¦‚ä¸‹
const element = React.createElement(
  "h1",
  { title: "foo" },
  "Hello"
);
```

æ‰€ä»¥ï¼Œè¦å®ç°ä¸€ä¸ªç®€å•çš„Reactï¼Œå°±å¿…é¡»å®ç°createElementä¸renderä¸¤ä¸ªæ–¹æ³•ï¼Œæˆ‘ä»¬è¿™é‡Œå¯ä»¥ç»Ÿä¸€åˆ°Didacté‡Œï¼Œä¹Ÿå°±æ˜¯ï¼š

```typescript
function createElement() {
  /** do sth */
}
function render() {
  /** do sth */
}
const Didact = {
  createElement,
  render,
};
```

## å®ç°createElementæ–¹æ³•

ä¸¾ä¸€ä¸ªä¸Šé¢ä¾‹å­çš„å˜å½¢ï¼š

```typescript
const element = (
  <h1 title="foo">
    <div>123</div>
    Hello
  </h1>
);
```

å¯¹äºæ­¤elementï¼Œéœ€è¦ä¸‰ä¸ªå­—æ®µæ¥å¯¹å®ƒè¿›è¡Œæè¿°ï¼š

- ç±»å‹ â€”â€” h1

- å±æ€§ â€”â€” title="foo"

- å­©å­ â€”â€” \<div>123\</div>ä¸Hello

æ‰€ä»¥ï¼ŒcreateElementçš„å…¥å‚å¯ä»¥è®¾å®šä¸ºtypeã€propsã€childrenï¼Œå…¶ä¸­childrenå‚æ•°å¯ä»¥æœ‰å¤šä¸ªï¼Œè¿”å›ç±»å‹ä¸ºDidactElementï¼Œå¯ä»¥å°†childrenåˆå¹¶åˆ°propsä¸­ç®¡ç†ï¼Œäº‹å®ä¸Šåœ¨Reactä¸­æˆ‘ä»¬ä¹Ÿæ˜¯é€šè¿‡&#x20;

`const { children } = props;` æ¥è·å–å­©å­elementsï¼Œè¿™é‡Œæˆ‘ä»¬å¯¹ç…§Didactæºç æ¥çœ‹ï¼š

```typescript
type DidactElement = {
  type: string | function; // æœ¬ç¯‡æ–‡ç« åªå®ç°åŸç”Ÿç»„ä»¶å’Œå‡½æ•°å¼ç»„ä»¶
  props: { children: DidactElement[]; [props: string]: any };
};
/**
* @param type
  å…ƒç´ ç±»å‹ï¼Œå¯èƒ½æ˜¯åŸç”Ÿçš„divã€h1ç­‰ï¼Œä¹Ÿå¯èƒ½æ˜¯Function Componentç­‰
* @param props
  å…ƒç´ å±æ€§ï¼ŒåŸç”ŸèŠ‚ç‚¹ä¸­å¯¹åº”DOM propertiesï¼ŒFCä¸­å¯¹åº”ç»„ä»¶çš„ä¼ å€¼
  @param ...children
  å­©å­elementsï¼Œæ•°ç›®ä¸ç¡®å®š
  @return DidactElement
*/
function createElement(
  type: string,
  props: Record<string, any>,
  ...children: DidactElement[]
): DidactElement {
  return {
    type,
    props: {
      ...props,
      // æ­¤å¤„è¦åˆ¤æ–­ä¼ å…¥çš„æ˜¯jsx elementè¿˜æ˜¯æ–‡æœ¬ï¼Œæ–‡æœ¬å¦ä½œå¤„ç†
      children: children.map((child) =>
        typeof child === "object" ? child : createTextElement(child),
      ),
    },
  };
}

// æ–‡æœ¬èŠ‚ç‚¹å¤„ç†çš„æ–¹æ³•ï¼Œç›¸æ¯”jsx elementï¼Œå…¶typeå’Œpropséƒ½æ¯”è¾ƒå›ºå®šï¼Œä¸”æ— children
function createTextElement(text: string): DidactElement {
  return {
    type: "TEXT_ELEMENT",
    props: {
      nodeValue: text,
      children: [],
    },
  };
}
```

ç°åœ¨æœ‰äº†createElementæ–¹æ³•ï¼Œæ¥ä¸‹æ¥å¯ä»¥ç”¨babelæ¥åštransformï¼Œåªéœ€è¦åŠ ä¸€è¡Œæ³¨é‡Šï¼Œæ„å»ºæ—¶babelå°±ä¼šå°†JSXè½¬ä¹‰ä¸ºDidact.createElement()ï¼š

```typescript
/** @jsx Didact.createElement */
const element = (
  <h1 title="foo">
    <div>123</div>
    Hello
  </h1>
);
```

## å®ç°ä¸€ä¸ªåŸå§‹çš„renderæ–¹æ³•

å®ç°createElementæ–¹æ³•åï¼Œå¯ä»¥å¼€å§‹ç€æ‰‹renderæ–¹æ³•ã€‚é€šè¿‡ä¸Šé¢çš„ä¾‹å­å¯çŸ¥ï¼Œrenderçš„å…¥å‚æœ‰ä¸¤ä¸ªï¼Œæ¸²æŸ“çš„å…ƒç´ elementå’Œå®¹å™¨containerã€‚æˆ‘ä»¬å¯ä»¥é€šè¿‡DOMæ“ä½œåŸºæœ¬å®ç°ä¸€ä¸ªåŸå§‹çš„renderæ–¹æ³•ï¼š

```typescript
function render(element: DidactElement, container: HTMLElement) {
  // æ ¹æ®elementåˆ›å»ºçœŸå®çš„èŠ‚ç‚¹
  const dom =
    element.type == "TEXT_ELEMENT"
      ? document.createTextNode("")
      : document.createElement(element.type);
  // å°†DOM PropertiesåŠ å…¥åˆ°åˆ›å»ºçš„èŠ‚ç‚¹ä¸Š
  Object.keys(element.props)
    .filter((key) => key !== "children")
    .forEach((name) => {
      dom[name] = element.props[name];
    });
  // é€’å½’ï¼Œå°†æ¯ä¸€ä¸ªå­©å­èŠ‚ç‚¹æ¸²æŸ“å‡ºæ¥ï¼Œæ³¨æ„æ­¤æ—¶å®¹å™¨ä¸ºå½“å‰èŠ‚ç‚¹
  element.props.children.forEach((child) => render(child, dom));
  // å°†èŠ‚ç‚¹æ’å…¥åˆ°å®¹å™¨ä¸­
  container.appendChild(dom);
}
```

ç”±æ­¤ï¼Œä¸€ä¸ªé™æ€çš„**JSX** --> **DOM**çš„è½¬åŒ–æˆå‹äº†ï¼Œåœ¨æ¥ä¸‹æ¥çš„ç« èŠ‚ä¸­ï¼Œæˆ‘ä»¬ä¼šå®ç°Didactèµ–ä»¥å·¥ä½œçš„æ ¸å¿ƒæœºåˆ¶ â€”â€” Fiberæ¶æ„ï¼Œæ‰€ä»¥åŸå§‹çš„renderæ–¹æ³•ä¹Ÿä¼šéšç€åç»­çš„è®²è§£æ¥é‡å†™ã€å®Œå–„

## å‰ç½®çŸ¥è¯†ï¼šConcurrentæ¨¡å¼

åœ¨è®²è¿°Fiberæ¶æ„ä¹‹å‰ï¼Œæˆ‘ä»¬éœ€è¦äº†è§£ä¸€ä¸ªå‰ç½®çš„çŸ¥è¯† â€”â€” Concurrentæ¨¡å¼ã€‚

ä¸Šè¿°renderå‡½æ•°ä¸­ï¼Œä¼šé€’å½’å¤„ç†å­©å­elementsç›´åˆ°ç”Ÿæˆå®Œæ•´DOMï¼ŒJSçº¿ç¨‹é‡Šæ”¾ï¼ŒGUIçº¿ç¨‹æ‰ä¼šè¿›è¡Œæ¸²æŸ“å·¥ä½œã€‚è¿™ä¸ªé€’å½’çš„è¿‡ç¨‹æ˜¯ä¸å¯ä¸­æ–­çš„ï¼Œå¦‚æœElement Treeç»“æ„éå¸¸å¤æ‚ï¼Œåˆ™ä¼šå¯¼è‡´JSæ‰§è¡Œæ—¶é—´è¿‡é•¿ï¼ŒGUIçº¿ç¨‹å·¥ä½œé˜»å¡ï¼Œç•Œé¢ä¼šæ‰å¸§å¡é¡¿ï¼Œç”¨æˆ·ä½¿ç”¨ä½“éªŒä¼šå¤§æ‰“æŠ˜æ‰£ã€‚

æ‰€ä»¥ï¼Œæƒ³è¦æå‡ç”¨æˆ·çš„ä½“éªŒï¼Œæœ‰ä¸€ç§æ€è·¯å°±æ˜¯åœ¨æ¯ä¸€å¸§çš„æ—¶é—´å†…ï¼Œé¢„ç•™**ä¸€å®šæ—¶é—´**ç»™JSçº¿ç¨‹ï¼Œè®©ä»–å¤„ç†JSï¼Œæ²¡æœ‰å¤„ç†å®Œæˆçš„å·¥ä½œç•™åˆ°ä¸‹ä¸€å¸§ä¸­ç»§ç»­è¿›è¡Œï¼Œè€Œ**å‰©ä¸‹çš„æ—¶é—´**ç»™GUIçº¿ç¨‹æ¥è¿›è¡Œæ¸²æŸ“ï¼Œä¿è¯ç”¨æˆ·çœ‹åˆ°çš„ç”»é¢æ˜¯æµç•…çš„ï¼Œè¿™ä¹Ÿæ˜¯time slice(æ—¶é—´åˆ‡ç‰‡)çš„æ€æƒ³ã€‚

æµè§ˆå™¨æœ‰ä¸€ä¸ªå®éªŒæ€§çš„API â€”â€” [requestIdleCallback](https://developer.mozilla.org/zh-CN/docs/Web/API/Window/requestIdleCallback)ï¼Œè¿™ä¸ªAPIå¯ä»¥ä½¿æˆ‘ä»¬åœ¨æµè§ˆå™¨å½“å‰å¸§æœ‰ç©ºé—²æ—¶é—´æ—¶æ‰§è¡ŒJSï¼Œé€šè¿‡æ­¤æ–¹æ³•æˆ‘ä»¬å¯ä»¥æ‹¿åˆ°å½“å‰å¸§çš„å‰©ä½™å¯ç”¨æ—¶é—´ï¼Œä¸€èˆ¬ç”¨æ³•å¦‚ä¸‹ï¼š

```typescript
type Deadline = {
  timeRemaining: () => number; // å½“å‰å‰©ä½™çš„å¯ç”¨æ—¶é—´ï¼Œå³è¯¥å¸§å‰©ä½™æ—¶é—´
  didTimeout: boolean; // æ˜¯å¦è¶…æ—¶
};
// è¯¥æ–¹æ³•æ‰§è¡Œcallbackæ—¶ä¼šä¼ å…¥è¯¥å‚æ•°
function work(deadline: Deadline) {
  // å¦‚æœå‰©ä½™å¯ç”¨æ—¶é—´>1msæˆ–è€…æ²¡æœ‰è¶…æ—¶ï¼Œå³è¯´æ˜å½“å‰å¸§è¿˜æœ‰å‰©ä½™æ—¶é—´ï¼Œå¯ä»¥æ‰§è¡ŒJS
  if (deadline.timeRemaining() > 1 || deadline.didTimeout) {
    // do sth
  }
  // å¦‚æœæ²¡æœ‰å‰©ä½™æ—¶é—´ï¼Œåˆ™ç­‰å¾…ä¸‹ä¸€å¸§ï¼›æˆ–è€…å®Œæˆå·¥ä½œåç»§ç»­ç­‰å¾…ä¸‹ä¸€è½®æ‰§è¡Œ
  requestIdleCallback(work);
}
requestIdleCallback(work);
```

ä½†æ­¤ç”¨æ³•è¿˜æ˜¯æœ‰é—®é¢˜ï¼Œç¬¬9è¡Œçš„do somethingä¸€æ—¦å¼€å§‹ä¾æ—§ä¸ä¼šåœæ­¢ï¼Œæ‰€ä»¥å¦‚æœæŠŠä¸Šé¢æåˆ°çš„é€’å½’çš„è¿‡ç¨‹æ”¾åˆ°è¿™é‡Œï¼Œä¾æ—§ä¼šä¸€ç›´æ‰§è¡Œæ— æ³•ä¸­æ–­ã€‚

é€ æˆè¿™ç§æƒ…å†µçš„æœ¬è´¨åŸå› æ˜¯æ‰€æœ‰çš„é€’å½’å·¥ä½œéƒ½è€¦åˆåœ¨ä¸€èµ·ï¼Œå› æ­¤æˆ‘ä»¬ç¬¬8è¡Œåªåˆ¤æ–­äº†ä¸€æ¬¡ã€‚å¦‚æœå¯ä»¥æŠŠè¿™ä¸ªå·¥ä½œåˆ†å‰²æˆä¸€ä¸ªä¸€ä¸ªçš„**å•å…ƒ**ï¼Œè¿™æ ·æ¯ä¸ªå•å…ƒè¶…æ—¶çš„æ¦‚ç‡ä¼šè¿œè¿œå°äºæ€»å·¥ä½œè¶…æ—¶çš„æ¦‚ç‡ã€‚

å› æ­¤ï¼Œæˆ‘ä»¬å°†é€’å½’çš„å½¢å¼è½¬å˜ä¸ºå¾ªç¯çš„å½¢å¼ï¼Œå¯¹ä¸€ä¸ªä¸ªå•å…ƒè¿›è¡Œå¤„ç†ï¼Œè€Œåœ¨å¾ªç¯ä¸­æˆ‘ä»¬æ¯ä¸€æ¬¡éƒ½å¯ä»¥è¿›è¡Œç¬¬8è¡Œçš„åˆ¤æ–­ï¼Œå°±å¯ä»¥è§£å†³è¿™ä¸ªé—®é¢˜äº†ï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š

```typescript
function work(deadline: Deadline) {
  // å¾ªç¯åœ°ã€ä¸€ä¸ªä¸€ä¸ªå•å…ƒåœ°è¿›è¡Œå·¥ä½œ
  while (deadline.timeRemaining() > 1 || deadline.didTimeout) {
    // åªåšä¸€ä¸ªå•å…ƒçš„å·¥ä½œ
  }
  // é€€å‡ºå¾ªç¯åï¼Œç­‰å¾…ä¸‹ä¸€è½®çš„ç©ºé—²æ—¶é—´å¯ä»¥ç»§ç»­ä¸Šé¢çš„å·¥ä½œ
  requestIdleCallback(work);
}
requestIdleCallback(work);
```

åŒæ—¶ï¼Œè¿™ä¹Ÿæ˜¯Fiberæ¶æ„çš„æ ¸å¿ƒæ€æƒ³ä¹‹ä¸€ï¼Œæ¥ä¸‹æ¥æˆ‘ä»¬å°†å¼€å§‹ä»‹ç»å¹¶å®ç°Fiberæ¶æ„ã€‚

## Fiberæ¶æ„ä¸ä¸¤ä¸ªé˜¶æ®µ

åœ¨ä¸»æµçš„Vueã€Reactæ¡†æ¶ä¸­ï¼Œéƒ½æ²¿ç”¨äº†è™šæ‹ŸDOMè¿™ä¸€æ€æƒ³ï¼Œå³ç”¨JavaScriptå¯¹è±¡æ¥æè¿°æµè§ˆå™¨çš„DOMï¼Œç”¨ä¸€ä¸ªJSçš„æ ‘å½¢ç»“æ„æ¥æè¿°ä¸€ä¸ªçœŸå®çš„DOMæ ‘ã€‚

åœ¨Reactä¸­ç”¨Fiberè¿™ç§æ•°æ®ç»“æ„æ¥å®ç°è™šæ‹ŸDOMè¿™ä¸€æ€æƒ³ â€”â€” å…ˆæ ¹æ®Element Treeç”ŸæˆFiber Treeï¼Œå†æ ¹æ®Fiber Treeå¢åˆ æ”¹çœŸå®çš„DOM Treeã€‚

å› æ­¤ï¼Œç»¼åˆä¸Šè¿°çŸ¥è¯†ï¼Œæˆ‘ä»¬å¯ä»¥å¼•å‡ºè‡ªv16ä¹‹åReacté‡‡å–çš„æ–°çš„å…¨æ–°çš„æ¶æ„ â€”â€” Fiberæ¶æ„ï¼Œè¿™ä¸ªæ¶æ„ç”±ä¸‰ä¸ªéƒ¨åˆ†ç»„æˆï¼š

- Schedulerï¼ˆè°ƒåº¦å™¨ï¼‰â€”â€” è°ƒåº¦ä»»åŠ¡çš„ä¼˜å…ˆçº§ï¼Œé«˜ä¼˜ä»»åŠ¡ä¼˜å…ˆè¿›å…¥Reconciler

- Reconcilerï¼ˆåè°ƒå™¨ï¼‰â€”â€” è´Ÿè´£æ‰¾å‡ºå˜åŒ–çš„ç»„ä»¶ï¼Œå¯ä»¥è¢«ä¸­æ–­ï¼Œå¯¹åº”Renderé˜¶æ®µ

- Rendererï¼ˆæ¸²æŸ“å™¨ï¼‰â€”â€” è´Ÿè´£å°†å˜åŒ–çš„ç»„ä»¶æ¸²æŸ“åˆ°é¡µé¢ä¸Šï¼Œä¸è¢«ä¸­æ–­ï¼Œå¯¹åº”Commité˜¶æ®µ

å…¶ä¸­Schedulerç”±ä¸Šè¿°æåˆ°çš„requestIdleCallbackæ¥å®ç°ï¼ˆå®é™…ä¸ŠReactå—é™äºæµè§ˆå™¨çš„å…¼å®¹æ€§å’ŒåŠŸèƒ½ä¸Šçš„å¾®å°å·®å¼‚é€‰æ‹©äº†è‡ªå·±å®ç°ï¼‰ã€‚

Fiberæ¶æ„çš„æ ¸å¿ƒæ¦‚å¿µå°±æ˜¯FiberèŠ‚ç‚¹åŠå…¶æ„æˆçš„Fiber Treeï¼š

![image](/posts/didact/fiber-tree.png)

å¦‚å›¾ï¼ŒFiber Treeæ˜¯ä¸€ä¸ªæ ‘å½¢ç»“æ„ï¼Œä¸ä¼ ç»Ÿæ ‘å½¢ç»“æ„ç›¸æ¯”ï¼ŒFiber Treeçš„æ¯ä¸€ä¸ªçˆ¶èŠ‚ç‚¹çš„childæŒ‡é’ˆåªæŒ‡å‘é•¿å­ï¼Œé•¿å­ä¸å…„å¼Ÿä¹‹é—´å†é€šè¿‡siblingè¿æ¥ï¼Œè€Œä¸”æ‰€æœ‰çš„å­©å­éƒ½æœ‰ä¸€ä¸ªparentæŒ‡é’ˆæŒ‡å‘çˆ¶èŠ‚ç‚¹ã€‚

åœ¨Didactä¸­ä¼šæœ‰ä¸¤æ£µFiber Treeï¼Œä¸€æ£µæ˜¯Current Fiber Treeï¼Œå³å½“å‰æ­£åœ¨å‘ˆç°çš„DOMå¯¹åº”çš„Fiber Treeï¼Œè¿˜æœ‰ä¸€æ£µæ˜¯WorkInProgress Fiber Treeï¼Œæ˜¯æ­£åœ¨è¿›è¡Œæ„å»ºçš„æ ‘ï¼Œä¸¤æ£µæ ‘ä¸­å¯¹åº”çš„èŠ‚ç‚¹é€šè¿‡FiberèŠ‚ç‚¹ä¸Šçš„alternateæŒ‡é’ˆè¿æ¥ã€‚

è‡³æ­¤æˆ‘ä»¬å¯ä»¥å¾—å‡ºFiberèŠ‚ç‚¹çš„æ•°æ®ç»“æ„å³ï¼š

```typescript
type Fiber = {
  type?: string | function; // Fiber Root ä¸éœ€è¦æ­¤ç±»å‹ï¼Œè¯¦è§
  props: { children: DidactElement[]; [props: string]: any };
  dom: HTMLElement | null;
  alternate: Fiber | null;
  parent?: Fiber;
  child?: Fiber;
  sibling?: Fiber;
  effectTag?: string;
  hooks?: hook[];
};
// ä¸‹é¢å°†ä¼šç”¨åˆ°
type hook = <T>(
  initialValue?: T | (() => T),
) => [T | undefined, (value: T) => T];
```

æ¥ä¸‹æ¥ä¼šå…·ä½“ä»‹ç»Didactå·¥ä½œä¸¤ä¸ªé˜¶æ®µï¼Œå·¥ä½œæµç¨‹å¦‚ä¸‹ï¼š

![image.png](/posts/didact/didact-step.png)
æ•´ä¸ªå·¥ä½œæµç¨‹ä¸­çš„å…¥å£å°±æ˜¯workloopå‡½æ•°ï¼Œå¯ä»¥å¯¹ç…§å›¾å’Œæºç çœ‹ä¸€ä¸‹workloopåšäº†ä»€ä¹ˆäº‹æƒ…ï¼š

```TypeScript
let nextUnitOfWork: FiberÂ | null = null;
let currentRoot: Fiber | null = null;
let wipRoot: Fiber | null = null;
let deletions: Fiber[] | null = null;

function workLoop(deadline: Deadline) {
  let shouldYield = false;
  // æ¯è¿›è¡Œä¸€ä¸ªå•å…ƒçš„å·¥ä½œï¼Œå°±ä¼šè¿›è¡Œåˆ¤æ–­ï¼Œå¯éšæ—¶ä¸­æ–­ï¼Œæ­¤æ—¶æ˜¯Schedulerå’ŒReconcileråœ¨å·¥ä½œ
  // ä¸­æ–­åç»§ç»­æ‰§è¡Œæ—¶ï¼ŒnextUnitOfWorkæ˜¯å…¨å±€å˜é‡ï¼Œå› æ­¤å¯ä»¥å–åˆ°ä¸Šä¸€æ¬¡çš„ä¸­æ–­å‰çš„nextUnitOfWorkç»§ç»­è¿›è¡Œå·¥ä½œ
  // è¿™å°±æ˜¯é€’å½’å˜å¾ªç¯çš„å¥½å¤„ï¼ŒçœŸæ­£çš„è·µè¡Œäº†time sliceçš„æ€æƒ³
  while (nextUnitOfWork && !shouldYield) {
    // dfséå†
    nextUnitOfWork = performUnitOfWork(
      nextUnitOfWork
    );
    shouldYield = deadline.timeRemaining() < 1;
  }
  // å½“wip fiberæ„å»ºå®Œæˆï¼Œå°±å¯ä»¥è¿›å…¥commité˜¶æ®µäº†ï¼Œæ­¤æ—¶æ˜¯Rendereråœ¨å·¥ä½œ
  if (!nextUnitOfWork && wipRoot) {
    commitRoot();
  }
  requestIdleCallback(workLoop);
}

requestIdleCallback(workLoop);
```

### Renderé˜¶æ®µ

Renderé˜¶æ®µåšçš„äº‹æƒ…å°±æ˜¯å°†Element --> Fiberã€‚

![image.png](/posts/didact/step-render.png)

å…¶æ ¸å¿ƒæ–¹æ³•å°±æ˜¯performUnitOfWorkï¼Œæ¥ä¸‹æ¥ç›´æ¥å¯¹ç…§æºç è¿›è¡Œè§£æï¼š

```typescript
/**
 * æ­¤æ–¹æ³•çš„ä½œç”¨ï¼š
 * 1. å°†å½“å‰fiberçš„props.childrenä¸­çš„elementsç”ŸæˆfiberèŠ‚ç‚¹å¹¶è¿æ¥èµ·æ¥
 * 2. è¿”å›é•¿å­èŠ‚ç‚¹ï¼Œå³fiber.childï¼›è‹¥æ²¡æœ‰å­©å­åˆ™è¿”å›å…„å¼ŸèŠ‚ç‚¹æˆ–å”è¾ˆèŠ‚ç‚¹
 */
function performUnitOfWork(fiber: Fiber) {
  // è¿™ä¸¤ä¸ªupdateå‡½æ•°å®ç°åŠŸèƒ½1
  const isFunctionComponent = fiber.type instanceof Function;
  if (isFunctionComponent) {
    updateFunctionComponent(fiber);
  } else {
    updateHostComponent(fiber);
  }
  // å®ç°åŠŸèƒ½2
  if (fiber.child) {
    return fiber.child;
  }
  // å¦‚æœæ²¡æœ‰å­©å­èŠ‚ç‚¹äº†ï¼Œåˆ™è¿”å›å…„å¼ŸèŠ‚ç‚¹æˆ–è€…å”è¾ˆèŠ‚ç‚¹ï¼Œå³dfsçš„è¿‡ç¨‹
  let nextFiber = fiber;
  while (nextFiber) {
    if (nextFiber.sibling) {
      return nextFiber.sibling;
    }
    nextFiber = nextFiber.parent;
  }
}

function updateHostComponent(fiber: Fiber) {
  if (!fiber.dom) {
    fiber.dom = createDom(fiber);
  }
  // ä¸Šè¿°åŠŸèƒ½1çš„å…·ä½“å®ç°
  reconcileChildren(fiber, fiber.props.children);
}
function updateFunctionComponent(fiber: Fiber) {
  // do sth
}
// å½“æ ‡è®°ä¸º"PLACEMENT"æ—¶ï¼Œå³æ–°å¢DOMï¼Œéœ€è¦æ‰§è¡Œæ­¤å‡½æ•°åˆ›å»ºä¸€ä¸ªDOM
function createDom(fiber: Fiber) {
  const dom =
    fiber.type == "TEXT_ELEMENT"
      ? document.createTextNode("")
      : document.createElement(fiber.type);
  // åŒæ—¶å°†å±æ€§æ³¨å…¥
  updateDom(dom, {}, fiber.props);
  return dom;
}
```

```typescript
// æ¥æ”¶fiberèŠ‚ç‚¹åŠå…¶å­©å­elementsä½œä¸ºå‚æ•°ï¼Œå°†å­©å­elementsç”Ÿæˆå­©å­fiberå¹¶ä¸fiberèŠ‚ç‚¹è¿æ¥
function reconcileChildren(wipFiber: Fiber, elements: DidactElement[]) {
  let index = 0;
  // è¦è¿›è¡Œå·¥ä½œçš„èŠ‚ç‚¹å¯¹åº”çš„old fiberèŠ‚ç‚¹ï¼Œåˆå§‹å€¼ä¸ºé•¿å­èŠ‚ç‚¹
  let oldFiber = wipFiber.alternate && wipFiber.alternate.child;
  // å‰é¢å®Œæˆçš„wip fiberçš„å­©å­èŠ‚ç‚¹ï¼Œç”¨æ¥åšå…„å¼Ÿä¹‹é—´çš„è¿æ¥
  let prevSibling: Fiber | null = null;
  // å¾ªç¯å°†å­©å­ä»¬ç”Ÿæˆfiberï¼Œå¹¶ä¸current fiberèŠ‚ç‚¹è¿›è¡Œå¯¹æ¯”æ‰“ä¸Šæ ‡è®°
  while (index < elements.length || oldFiber !== null) {
    const element = elements[index];
    let newFiber: Fiber | null = null;

    const sameType = oldFiber && element && element.type == oldFiber.type;

    if (sameType) {
      newFiber = {
        type: oldFiber.type,
        props: element.props,
        dom: oldFiber.dom,
        parent: wipFiber,
        alternate: oldFiber,
        effectTag: "UPDATE",
      };
    }
    if (element && !sameType) {
      newFiber = {
        type: element.type,
        props: element.props,
        dom: null,
        parent: wipFiber,
        alternate: null,
        effectTag: "PLACEMENT",
      };
    }
    /**
     åˆ é™¤çš„æ—¶å€™æ¯”è¾ƒç‰¹æ®Šï¼Œå› ä¸ºåˆ é™¤åæ–°çš„æ ‘ä¸­å°±ä¸åº”è¯¥æœ‰è¯¥FiberèŠ‚ç‚¹äº†ï¼Œæ‰€ä»¥åªèƒ½åœ¨
     è€çš„æ ‘ä¸­çš„FiberèŠ‚ç‚¹ä¸Šå­˜å‚¨æ ‡è®°ï¼Œå¹¶ç”¨ä¸€ä¸ªå…¨å±€çš„æ•°ç»„deletionså­˜å‚¨è¿™äº›èŠ‚ç‚¹
    */
    if (oldFiber && !sameType) {
      oldFiber.effectTag = "DELETION";
      deletions.push(oldFiber);
    }
    // ç»“æŸå½“å‰elementå»ºfiberçš„å·¥ä½œï¼Œå°†oldFiberæ›´æ–°ä¸ºä¸‹ä¸€è½®çš„oldFiber
    if (oldFiber) {
      oldFiber = oldFiber.sibling;
    }
    // å¦‚æœæ˜¯é•¿å­èŠ‚ç‚¹åˆ™å°†è¿æ¥çˆ¶èŠ‚ç‚¹ä¸é•¿å­èŠ‚ç‚¹ï¼Œä¸æ˜¯åˆ™è¿æˆå‰ä¸€è½®çš„èŠ‚ç‚¹çš„å…„å¼ŸèŠ‚ç‚¹
    if (index === 0) {
      wipFiber.child = newFiber;
    } else if (element) {
      prevSibling.sibling = newFiber;
    }
    // æ›´æ–°prevSiblingèŠ‚ç‚¹ï¼Œå¹¶è¿›å…¥ä¸‹ä¸€è½®
    prevSibling = newFiber;
    index++;
  }
}
```

![image.png](/posts/didact/diff-res.png)

è‡³æ­¤ï¼Œä»DidactElement --> Fiberçš„å·¥ä½œå®Œæˆï¼Œæˆ‘ä»¬æ‰¾åˆ°äº†å˜åŒ–çš„ç»„ä»¶ï¼Œå¹¶æ‰“ä¸Šäº†ç›¸åº”çš„æ ‡è®°ï¼Œåç»­åœ¨commité˜¶æ®µï¼Œä¼šæ ¹æ®ä¸åŒçš„æ ‡è®°è¿›è¡Œç›¸åº”çš„DOMæ“ä½œã€‚

å› æ­¤ï¼ŒåŸå§‹renderæ–¹æ³•å¯ä»¥è¿›è¡Œé‡å†™äº†ï¼š

```typescript
function render(element: DidactElement, container: HTMLElement) {
  wipRoot = {
    dom: container,
    props: {
      children: [element],
    },
    alternate: currentRoot,
  };
  deletions = [];
  /**
   æˆ‘ä»¬åªéœ€è¦å°†nextUnitOfWorkç½®ä¸ºæ ¹FiberèŠ‚ç‚¹ï¼ŒnextUnitOfWork && !shouldYield
   çš„åˆ¤æ–­æ¡ä»¶å°±ä¼šæ»¡è¶³ï¼Œworkloopæ–¹æ³•å°±ä¼šå¼€å§‹æ„å»ºFiber Treeå¹¶æœ€ç»ˆç”ŸæˆDOMæ ‘
  */
  nextUnitOfWork = wipRoot;
}
```

### Commité˜¶æ®µ

![image.png](/posts/didact/step-commit.png)

Fiber Treeæ„å»ºå®Œæˆåï¼ŒnextUnitOfWorkä¼šå˜ä¸ºnullï¼ŒRenderé˜¶æ®µç»“æŸï¼Œå¼€å§‹æ‰§è¡ŒcommitRootæ–¹æ³•ï¼šç”¨WIP Fiber TreeåŠå…¶å¯¹åº”çš„DOM Treeæ¥æ›¿æ¢æ‰Current Fiber TreeåŠå…¶å¯¹åº”çš„DOM Treeã€‚

å…·ä½“çš„commitRootæ–¹æ³•ç›´æ¥å¯¹åº”æºç è¿›è¡Œè§£æï¼š

```typescript
function commitRoot() {
  // æ‰§è¡Œåˆ æ“ä½œ
  deletions.forEach(commitWork);
  // æ‰§è¡Œå¢å’Œæ”¹æ“ä½œ
  commitWork(wipRoot.child);
  // æ“ä½œå®ŒDOMåï¼Œç”¨WIP Fiber Treeæ›¿æ¢æ‰Current Fiber Tree
  currentRoot = wipRoot;
  // å°†WIP Fiber Treeç½®ç©º
  wipRoot = null;
}
```

```typescript
// è¿›è¡Œå…·ä½“çš„å¢åˆ æ”¹æ“ä½œ
function commitWork(fiber: Fiber) {
  // é€’å½’å‡ºå£
  if (!fiber) {
    return;
  }

  let domParentFiber = fiber.parent;
  // å¦‚æœçˆ¶Fiberæ²¡æœ‰domï¼Œåˆ™æ‰¾åˆ°ç¬¬ä¸€ä¸ªæœ‰domçš„ç¥–å…ˆFiberèŠ‚ç‚¹ï¼Œå‚è€ƒå›¾
  while (!domParentFiber.dom) {
    domParentFiber = domParentFiber.parent;
  }
  const domParent = domParentFiber.dom;

  if (fiber.effectTag === "PLACEMENT" && fiber.dom !== null) {
    // è¿™ä¸€æ­¥çš„domæ˜¯åœ¨Renderé˜¶æ®µå°±å»ºå¥½äº†ï¼Œæ‰€ä»¥åªéœ€æ’å…¥
    domParent.appendChild(fiber.dom);
  } else if (fiber.effectTag === "UPDATE" && fiber.dom !== null) {
    // æ›´æ–°DOMçš„å…·ä½“é€»è¾‘
    updateDom(fiber.dom, fiber.alternate.props, fiber.props);
  } else if (fiber.effectTag === "DELETION") {
    commitDeletion(fiber, domParent);
  }
  // dfsæ¨¡å¼è¿›è¡Œé€’å½’
  commitWork(fiber.child);
  commitWork(fiber.sibling);
}

function commitDeletion(fiber: Fiber, domParent: HTMLElement) {
  if (fiber.dom) {
    domParent.removeChild(fiber.dom);
  } else {
    // ä¸ä¸Šé¢ç›¸ä¼¼çš„é€»è¾‘ï¼Œæ²¡æœ‰domå°±å¯¹ç¬¬ä¸€ä¸ªæœ‰domçš„å­Fiberè¿›è¡Œåˆ é™¤æ“ä½œ
    commitDeletion(fiber.child, domParent);
  }
}
```

```typescript
const isEvent = (key: string) => key.startsWith("on");
const isProperty = (key: string) => key !== "children" && !isEvent(key);
const isNew =
  (prev: Record<string, any>, next: Record<string, any>) => (key: string) =>
    prev[key] !== next[key];
const isGone =
  (prev: Record<string, any>, next: Record<string, any>) => (key: string) =>
    !(key in next);

function updateDom(
  dom: HTMLElement,
  prevProps: Record<string, any>,
  nextProps: Record<string, any>,
) {
  // ç§»é™¤æ—§çš„ç›‘å¬äº‹ä»¶
  Object.keys(prevProps)
    .filter(isEvent)
    .filter((key) => !(key in nextProps) || isNew(prevProps, nextProps)(key))
    .forEach((name) => {
      const eventType = name.toLowerCase().substring(2);
      dom.removeEventListener(eventType, prevProps[name]);
    });

  // å¢åŠ æ–°çš„ç›‘å¬äº‹ä»¶
  Object.keys(nextProps)
    .filter(isEvent)
    .filter(isNew(prevProps, nextProps))
    .forEach((name) => {
      const eventType = name.toLowerCase().substring(2);
      dom.addEventListener(eventType, nextProps[name]);
    });

  // ç§»é™¤æ—§çš„DOM properties
  Object.keys(prevProps)
    .filter(isProperty)
    .filter(isGone(prevProps, nextProps))
    .forEach((name) => {
      dom[name] = "";
    });

  // å¢åŠ æ–°çš„çš„DOM properties
  Object.keys(nextProps)
    .filter(isProperty)
    .filter(isNew(prevProps, nextProps))
    .forEach((name) => {
      dom[name] = nextProps[name];
    });
}
```

è‡³æ­¤ï¼Œæ‰€æœ‰çš„DOMçš„å¢ã€åˆ ã€æ”¹æ“ä½œéƒ½å·²å®Œæˆï¼Œä½†æ˜¯è¿˜å¾…å®Œå–„ï¼š

1.  åªæ”¯æŒHost Componentã€‚Didactæœ€ç»ˆçš„ç›®æ ‡æ˜¯æ”¯æŒHost Componentå’ŒFunction Componentï¼›

2.  åªæœ‰renderå‡½æ•°æ‰§è¡Œç¬¬ä¸€æ¬¡æ¸²æŸ“ â€”â€” mountï¼Œè€Œæ²¡æœ‰æä¾›updateçš„å…¥å£ã€‚æ¥ä¸‹æ¥ä¸€å°èŠ‚ä¸­ï¼Œå®ç°State HookåŠŸèƒ½ï¼Œå°†ä¼šä¸ºæˆ‘ä»¬æä¾›setStateå‡½æ•°ä½œä¸ºupdateçš„å…¥å£ã€‚

## Function Component ä¸ State Hook

### æ— çŠ¶æ€çš„Function Component

ç”±ç®€å…¥ç¹ï¼Œæˆ‘ä»¬å¯ä»¥å…ˆå®ç°ä¸€ä¸ªæ— çŠ¶æ€çš„Function Componentã€‚

Function Componentå®è´¨ä¸Šå°±æ˜¯ä¸€ä¸ªå‡½æ•°ï¼Œå®ƒçš„FiberèŠ‚ç‚¹çš„typeå°±æ˜¯è¯¥å‡½æ•°ï¼Œæˆ‘ä»¬é€šè¿‡æ‰§è¡Œè¿™ä¸ªå‡½æ•°æ¥æ‹¿åˆ°å®ƒè¿”å›çš„elementsï¼Œä¹Ÿå°±æ˜¯å®ƒçš„å­elementsï¼Œè¦å®ç°Function Componentï¼Œåªéœ€è¦åœ¨[è¿™é‡Œ](https://bytedance.feishu.cn/docx/LtXndXQq2o6UdTxoon2cni8XnSh#LY8UdMsqWo0CgixgB8dcYGeGn6c)åšå·¥ä½œï¼Œæˆ‘ä»¬å¯ä»¥ç›´æ¥çœ‹æºç ï¼š

```typescript
let wipFiber: Fiber | null = null;
let hookIndex: number | null = null;

function updateFunctionComponent(fiber: Fiber) {
  wipFiber = fiber;
  // ç”¨æ•°ç»„æ¥å­˜å‚¨hooksï¼Œåœ¨Reactä¸­ç”¨é“¾è¡¨ï¼Œä¸‹ä¸€å°èŠ‚ä¼šç”¨åˆ°
  hookIndex = 0;
  wipFiber.hooks = [];
  // ä¸Host ComponenetåŒºåˆ«ä¹‹ä¸€å°±æ˜¯childrenéœ€è¦é€šè¿‡æ‰§è¡Œå‡½æ•°è·å¾—
  const children = [fiber.type(fiber.props)];
  reconcileChildren(fiber, children);
}
```

### å®ç°useState

useStateå®ç°åŸç†å…¶å®å¾ˆç®€å•ï¼š

- æ‰§è¡ŒsetStateå¯¼è‡´é‡æ¸²æŸ“ï¼›

- é‡æ¸²æŸ“çš„æ—¶å€™ï¼Œä¼šå†æ¬¡æ‰§è¡ŒFunction Componentå‡½æ•°ï¼›

- æ‰§è¡Œå‡½æ•°æ—¶ï¼Œä¼šæ‰§è¡ŒuseStateï¼Œæ‹¿åˆ°æœ€æ–°çš„stateï¼Œreturnçš„JSXä¸­ä½¿ç”¨äº†æœ€æ–°çš„stateï¼›

- stateçš„æµè½¬è¿‡ç¨‹ï¼šJSX â€”> Element â€”> Fiber â€”> DOMï¼Œæœ€ç»ˆè§†å›¾åˆ·æ–°ã€‚

æˆ‘ä»¬ç›´æ¥çœ‹Didactæºç ï¼š

```typescript
// æ­¤hooksåœ¨æ‰§è¡ŒupdateFunctionComponentçš„ç¬¬10è¡Œæ‰§è¡ŒFCçš„å‡½æ•°æ—¶æ‰§è¡Œ
function useState<T>(initial?: T) {
  // å–ä¹‹å‰æ—§æ ‘ä¸Šçš„å¯¹åº”hookï¼ˆé€šè¿‡hookIndexä¿è¯é¡ºåºï¼‰
  const oldHook =
    wipFiber.alternate &&
    wipFiber.alternate.hooks &&
    wipFiber.alternate.hooks[hookIndex];
  // stateåˆå€¼ä¸ºä¸Šä¸€æ¬¡çš„stateæˆ–è€…åˆå€¼ï¼ˆç¬¬ä¸€æ¬¡è°ƒç”¨æ—¶ï¼‰
  // queueç”¨æ¥å­˜å‚¨æ‰€æœ‰çš„setStateåŠ¨ä½œä»¥ä¾¿è¿›è¡Œæ‰¹å¤„ç†
  const hook = {
    state: oldHook ? oldHook.state : initial,
    queue: [],
  };
  // æ›´æ–°state
  const actions = oldHook ? oldHook.queue : [];
  actions.forEach((action) => {
    hook.state = action(hook.state);
  });
  // æ‰§è¡Œæ­¤å‡½æ•°åï¼Œä¼šè§¦å‘é‡æ–°æ„å»ºFiberæ ‘
  const setState = (action: (value: T) => T) => {
    // ä¸Šä¸€æ­¥ä¸­æ‰§è¡Œçš„å°±æ˜¯actionæ–¹æ³•ï¼Œæ­¤å¤„ä¼šå°†å…¶æ¨å…¥queue
    hook.queue.push(action);
    // æ‰§è¡Œæ›´æ–°ï¼Œåšçš„å·¥ä½œå’Œrenderæ–¹æ³•ç›¸ä¼¼ï¼Œå› æ­¤setStateæ˜¯updateçš„å…¥å£
    wipRoot = {
      dom: currentRoot.dom,
      props: currentRoot.props,
      alternate: currentRoot,
    };
    nextUnitOfWork = wipRoot;
    deletions = [];
  };
  // æ‰§è¡Œåå°†è¯¥hookæ¨å…¥æ–°æ ‘çš„hooksæ•°ç»„
  wipFiber.hooks.push(hook);
  // ä¸ºå¤„ç†ä¸‹ä¸€ä¸ªhookä½œå‡†å¤‡
  hookIndex++;
  // æ³¨æ„æ­¤æ—¶è¿”å›äº†ä¸€ä¸ªå‡½æ•°setState
  // setStateç”¨åˆ°äº†å‡½æ•°ä¸­çš„å±€éƒ¨å˜é‡hookï¼Œå› æ­¤å½¢æˆäº†ä¸€ä¸ªé—­åŒ…
  return [hook.state, setState];
}
```

1.  åˆæ¬¡æŒ‚è½½æ—¶ï¼Œç¬¬15è¡Œå¼€å§‹æ²¡æœ‰ä»»ä½•actionæ‰§è¡Œï¼›

1.  ä¸€åˆ‡å°±ç»ªåï¼Œåˆæ¬¡æŒ‚è½½æ—¶çš„WIP Fiber Treeå˜æˆäº†Current Fiber Treeï¼Œè€Œä¸”hookséƒ½å·²ç»å·²ç»æŒ‚è½½åˆ°äº†å¯¹åº”çš„Function Component FiberèŠ‚ç‚¹ä¸Šï¼›

1.  è§¦å‘setStateï¼Œå°±ä¼šè§¦å‘æ„å»ºä¸€æ£µæ–°çš„WIP Fiber Treeï¼Œæ­¤æ—¶ä¾¿ä¼šï¼š

è‡³æ­¤ï¼ŒDidactæˆå‹äº†ï¼š

```typescript
const Didact = {
  createElement,
  render,
  useState,
};
```

# æ€»ç»“

è‡³æ­¤ï¼Œæˆ‘ä»¬å®ç°äº†ä¸€ä¸ªç®€æ˜“ç‰ˆReactæ¡†æ¶ â€”â€” Didactï¼Œå®ƒå¯ä»¥æ”¯æŒæˆ‘ä»¬ä¹¦å†™JSXå¹¶æœ€ç»ˆå°†å®ƒæ¸²æŸ“åˆ°é¡µé¢ä¸Šï¼Œè¿˜å¯ä»¥å®ç°çŠ¶æ€é©±åŠ¨è§†å›¾ã€‚è¿™é‡Œæ˜¯å®Œæ•´çš„ä»£ç å’Œä¸€ä¸ªdemoï¼š

https://codesandbox.io/s/didact-8-21ost

DidactåŠŸèƒ½è¾ƒç®€å•ï¼Œè€Œåœ¨Reactä¸­åšäº†å¤§é‡çš„ä¼˜åŒ–å·¥ä½œï¼Œå¦‚é¡¶å±‚äº‹ä»¶ä»£ç†æœºåˆ¶ã€Fiberçš„bailoutæœºåˆ¶ï¼Œæ­¤æ¡†æ¶åªæ˜¯æ²¿ç”¨äº†Reactä¸­çš„è®¾è®¡ç†å¿µå’Œæ€æƒ³ï¼Œå¸Œæœ›å¯ä»¥ä¸ºå¤§å®¶å­¦ä¹ Reactæºç åšä¸€ç‚¹é“ºè·¯çš„å·¥ä½œã€‚

# å‚è€ƒæ–‡çŒ®

[react.iamkasong.com/](https://react.iamkasong.com/)
